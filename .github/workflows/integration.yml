name: Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build and Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        run: cargo build --release --verbose

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: target/release/

  kind-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.30.0"

      - name: Run kind integration tests
        run: |
          chmod +x scripts/kind-integration.sh

          # Run the shared integration test script
          # Note: The script builds static musl binaries for kind node compatibility
          ./scripts/kind-integration.sh

      - name: Capture kind cluster logs on failure
        if: always()
        continue-on-error: true
        run: |
          mkdir -p /tmp/debug-logs

          # Get kind cluster info
          kind get clusters > /tmp/debug-logs/kind-clusters.txt 2>&1 || true

          # Get kind node info
          docker ps -a --filter "name=reaper-ci" > /tmp/debug-logs/docker-ps.txt 2>&1 || true

          # Extract logs from kind node
          NODE_ID=$(docker ps -q --filter "name=reaper-ci-control-plane" 2>/dev/null) || true
          if [ -n "$NODE_ID" ]; then
            echo "Capturing logs from node: $NODE_ID" > /tmp/debug-logs/node-info.txt
            docker exec "$NODE_ID" journalctl -u containerd -n 200 --no-pager > /tmp/debug-logs/containerd-journal.log 2>&1 || true
            docker exec "$NODE_ID" journalctl -u kubelet -n 200 --no-pager > /tmp/debug-logs/kubelet-journal.log 2>&1 || true
            docker exec "$NODE_ID" tail -200 /var/log/containerd.log > /tmp/debug-logs/containerd-daemon.log 2>&1 || true
            docker exec "$NODE_ID" find /run/reaper -type f -exec cat {} \; > /tmp/debug-logs/reaper-state-files.txt 2>&1 || true
          fi

      - name: Upload debug logs
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: kind-debug-logs
          path: /tmp/debug-logs/
          retention-days: 7
